package com.example.instafocus

import android.content.Context
import android.content.SharedPreferences
import java.util.Calendar

object UsageTracker {

    private const val PREFS = "usage_prefs"
    private const val USED_TIME = "used_time"
    private const val LAST_DAY = "last_day"
    private const val LIMIT_SECONDS = 60 * 60

    private var sessionStart: Long = 0L

    fun startSession() {
        sessionStart = System.currentTimeMillis()
    }

    fun endSession(context: Context) {
        if (sessionStart == 0L) return

        val now = System.currentTimeMillis()
        val sessionSeconds = (now - sessionStart) / 1000
        sessionStart = 0L

        val prefs = prefs(context)
        resetIfNewDay(prefs)

        val used = prefs.getLong(USED_TIME, 0)
        prefs.edit().putLong(USED_TIME, used + sessionSeconds).apply()
    }

    fun isLimitReached(context: Context): Boolean {
        val prefs = prefs(context)
        resetIfNewDay(prefs)
        return prefs.getLong(USED_TIME, 0) >= LIMIT_SECONDS
    }

    private fun resetIfNewDay(prefs: SharedPreferences) {
        val today = Calendar.getInstance().get(Calendar.DAY_OF_YEAR)
        val savedDay = prefs.getInt(LAST_DAY, -1)

        if (today != savedDay) {
            prefs.edit()
                .putInt(LAST_DAY, today)
                .putLong(USED_TIME, 0)
                .apply()
        }
    }

    private fun prefs(context: Context): SharedPreferences {
        return context.getSharedPreferences(PREFS, Context.MODE_PRIVATE)
    }
}
